<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>MyDrive - 구글 드라이브 UI</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f8f9fa;
        }
        .navbar {
            background-color: #4285f4;
            color: white;
            padding: 1rem;
            font-size: 1.5rem;
        }
        .container {
            padding: 2rem;
        }
        .toolbar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        .folder, .file {
            display: inline-block;
            width: 150px;
            margin: 1rem;
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background-color: white;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: relative;
        }
        .folder:hover, .file:hover {
            background-color: #f1f3f4;
            cursor: pointer;
        }
        .icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }
        .upload-btn input {
            display: none;
        }
        #contextMenu {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            z-index: 1000;
            padding: 0.5rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        #contextMenu a {
            text-decoration: none;
            color: black;
            display: block;
            padding: 0.25rem 0.5rem;
        }
        #contextMenu a:hover {
            background-color: #f1f1f1;
        }
    </style>
</head>
<body>
<div class="navbar">
    <a th:href="@{/}" style="color: white; text-decoration: none;">MyDrive</a>
</div>
<div class="container">
    <div class="toolbar">
        <label class="upload-btn">
            📤 파일 업로드
            <input type="file" id="fileInput" />
        </label>
        <form th:action="@{/create-folder}" method="post">
            <input type="text" name="folderName" placeholder="폴더 이름" required>
            <input type="hidden" name="path" th:value="${currentPath}">
            <button type="submit">📁 폴더 만들기</button>
        </form>
    </div>
    <input type="hidden" id="currentPath" th:value="${currentPath}">
    <div class="file-list">
        <div th:each="folder : ${folders}" class="folder">
            <a th:href="@{'/drive?path=' + ${encodedPaths[folder.name]}}">
                <div class="icon">📁</div>
                <div th:text="${folder.name}"></div>
            </a>
        </div>

        <div th:each="file : ${files}" class="file"
             th:attr="data-filename=${file.originalFileName}"
             onclick="openFile(this.getAttribute('data-filename'))"
             oncontextmenu="showContextMenu(event, this.getAttribute('data-filename'))">
            <div class="icon">📄</div>
            <div th:text="${file.originalFileName}"></div>
        </div>
    </div>
</div>

<!-- 우클릭 메뉴 -->
<div id="contextMenu">
    <a id="downloadLink" href="#" download>⬇️ 다운로드</a>
</div>

<script>
    document.getElementById('fileInput').addEventListener('change', async function (event) {
        const file = event.target.files[0];
        if (!file) return;

        const chunkSize = 5 * 1024 * 1024; // 5MB
        const totalChunks = Math.ceil(file.size / chunkSize);
        const fileId = `${file.name}-${Date.now()}`;
        const path = document.getElementById('currentPath').value;

        for (let i = 0; i < totalChunks; i++) {
            const start = i * chunkSize;
            const end = Math.min(file.size, start + chunkSize);
            const chunk = file.slice(start, end);

            const formData = new FormData();
            formData.append("chunk", chunk);
            formData.append("chunkIndex", i);
            formData.append("totalChunks", totalChunks);
            formData.append("fileId", fileId);
            formData.append("originalFilename", file.name);
            formData.append("path", path);

            await fetch("/upload-chunk", {
                method: "POST",
                body: formData
            });
        }

        // 병합 요청
        await fetch(`/merge-chunks?fileId=${fileId}&filename=${encodeURIComponent(file.name)}&path=${encodeURIComponent(path)}`);
        alert("✅ 업로드 완료!");
        location.reload(); // 업로드 완료 후 화면 새로고침
    });

    // 우클릭 메뉴 감추기
    document.addEventListener("click", function () {
        document.getElementById("contextMenu").style.display = "none";
    });

    function showContextMenu(event, fileName) {
        event.preventDefault();
        const menu = document.getElementById("contextMenu");
        const downloadLink = document.getElementById("downloadLink");

        const path = encodeURIComponent(document.querySelector("#currentPath").value);
        downloadLink.href = `/download?filename=${encodeURIComponent(fileName)}&path=${path}`;

        menu.style.left = event.pageX + "px";
        menu.style.top = event.pageY + "px";
        menu.style.display = "block";
    }

    function openFile(fileName) {
        const currentPath = encodeURIComponent(document.querySelector("#currentPath").value);
        const encodedFile = encodeURIComponent(fileName);
        window.open(`/preview?filename=${encodedFile}&path=${currentPath}`, "_blank");
    }
</script>



</body>
</html>
